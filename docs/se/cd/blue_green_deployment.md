# 蓝绿部署(Blue-Green Deployment)

## 说明

`蓝绿部署(Blue-Green Deployment)`是一种服务端应用软件发布模式，可将用户流量从先前版本的应用或微服务逐渐转移到几乎相同的新版本中（两者均保持在生产环境中运行）。蓝绿部署的起源可以参考:<https://gitlab.com/-/snippets/1846041>。

当前版本的生产环境叫做`绿环境`，将要发布版本的生产环境叫做`蓝环境`。首先要部署`蓝环境`，并在部署完毕后进行`冒烟测试`。测试成功后将流量切换到`蓝环境`，一旦流量从`绿环境`完全转移到`蓝环境`。为了保持能够快速回滚，`绿环境`会留有一段时间的存活期，以便快速回滚至旧版本。

## 蓝绿部署过程

1. 初始化`蓝环境`。
2. 部署新版本应用至`蓝环境`，等待`蓝环境`为就绪状态。
3. 通过临时路由访问`蓝环境`做测试。
4. `蓝环境`通过测试后为就绪状态，准备替代`绿环境`。
5. 将`绿环境`的流量全部切换到`蓝环境`。
6. `绿环境`请求为 0 时表明发布成功。
7. 如`蓝环境`产生故障或者错误，则将流量切换回`绿环境`。此时保留`蓝环境`作为故障现场进行进一步分析。
8. 如`绿环境`经过一段时间运行正常，则通过回收`蓝环境`资源，`蓝环境`成为新的`绿环境`，等待下一次`蓝绿部署`。

## 使用技巧和注意事项

1. 由于`DNS`的`TTL`设置不可靠，故不能采用更新`DNS`的方式切换环境。
2. `蓝绿部署`需要创建 1:1 相同的资源，在用户流量切换期间和等待期间存在资源浪费。
3. 如果出现回滚至旧版本（`蓝环境`），下线的`绿环境`上会产生“脏数据”。解决“脏数据”的办法是在对每条数据的新增和更新都记录“最后一次修改”对应的应用版本号以应对规模化数据迁移和清洗。以及对于该部分用户的额外运营工作。
4. `蓝绿部署`可以看作是[金丝雀发布](canary_release.md)的一种极端场景。

## 工具 & 平台

（待补充）

## 参考和引用

- [Gitlab Snippets - Blue-Green deployment](https://gitlab.com/-/snippets/1846041)
- [martinfowler.com - Canary Release](https://martinfowler.com/bliki/BlueGreenDeployment.html)
